// GENERATED BY GEMINI
const path = require('path');
const { ConfigLoader } = require('../../core/utils/config');
const { FacebookAPI } = require('../../core/utils/facebook-api');

async function testMediaPosting() {
  console.log('Starting Facebook media posting test...');

  // Load environment configuration
  const env = ConfigLoader.loadEnvironment();
  if (!env.FB_PAGE_ID || !env.FB_PAGE_ACCESS_TOKEN) {
    console.error('Error: FB_PAGE_ID and FB_PAGE_ACCESS_TOKEN must be set in your .env file.');
    return;
  }

  // Initialize API
  const facebookAPI = new FacebookAPI(env.FB_PAGE_ID, env.FB_PAGE_ACCESS_TOKEN);

  // --- Test 1: Post a Photo ---
  console.log('\n--- 1. Testing Photo Upload ---');
  const photoPath = path.join(__dirname, '../../../media/sample.jpg');
  const photoCaption = `Test Photo Post - Gemini CLI\n${new Date().toISOString()}\n\nThis is a test image posted via the Graph API to confirm functionality.`;

  const photoResult = await facebookAPI.postPhoto({ photoPath, caption: photoCaption });

  if (photoResult.success) {
    const postUrl = `https://www.facebook.com/${photoResult.post_id}`;
    console.log('‚úÖ Photo posted successfully!');
    console.log(`   - Post ID: ${photoResult.post_id}`);
    console.log(`   - Preview URL: ${postUrl}`);
  } else {
    console.error('‚ùå Failed to post photo.');
    console.error(`   - Reason: ${photoResult.message}`);
    if (photoResult.error) {
      console.error(`   - API Error: ${JSON.stringify(photoResult.error, null, 2)}`);
      if (photoResult.error.error?.error_user_title) {
          console.error(`\n   üö® Recommendation: ${photoResult.error.error.error_user_title} - ${photoResult.error.error.error_user_msg}`);
      }
      if (photoResult.error.error?.code === 10) { // Permission error
          console.error('\n   üö® Recommendation: The application may be missing required permissions. Please ensure the app has `pages_manage_posts` and `pages_read_engagement` permissions and that the app is in Live Mode.');
      }
    }
  }

  // --- Test 2: Post a Video (Skipped) ---
  console.log('\n--- 2. Testing Video Upload ---');
  console.log('SKIPPED: `ffmpeg` is not available in the environment to create a sample video file.');
  console.log('The `postVideo` function is available in `facebook-api.js` but requires a video file to test.');
  /*
  const videoPath = path.join(__dirname, '../../../media/sample.mp4');
  const videoDescription = `Test Video Post - Gemini CLI\n${new Date().toISOString()}`;
  
  const videoResult = await facebookAPI.postVideo({ videoPath, description: videoDescription });
  
  if (videoResult.success) {
    // Note: Video uploads are async. The post isn't available immediately.
    // We get a video_id, not a post_id right away.
    const videoUrl = `https://www.facebook.com/${env.FB_PAGE_ID}/videos/${videoResult.videoId}`;
    console.log('‚úÖ Video upload started successfully!');
    console.log(`   - Video ID: ${videoResult.videoId}`);
    console.log(`   - It may take a few moments for the video to be processed and become visible.`);
    console.log(`   - Check URL: ${videoUrl}`);
  } else {
    console.error('‚ùå Failed to post video.');
    console.error(`   - Reason: ${videoResult.message}`);
    if (photoResult.error) {
      console.error(`   - API Error: ${JSON.stringify(photoResult.error, null, 2)}`);
    }
  }
  */
}

testMediaPosting().catch(console.error);
