// GENERATED BY GEMINI  
const path = require('path');
const fs = require('fs');
const { ConfigLoader } = require('./deal-aggregator/core/utils/config');
const { FacebookAPI } = require('./deal-aggregator/core/utils/facebook-api');

async function createSampleVideo() {
  const videoPath = path.join(__dirname, 'media/sample.mp4');
  
  if (fs.existsSync(videoPath)) {
    console.log('üìπ Using existing media/sample.mp4');
    return videoPath;
  }

  console.log('üìπ Creating sample video...');
  
  try {
    const { execSync } = require('child_process');
    const ffmpegCommand = `ffmpeg -f lavfi -i "color=c=blue:size=640x480:duration=3" -vf "drawtext=fontsize=30:fontcolor=white:x=(w-text_w)/2:y=(h-text_h)/2:text='Video Test'" -c:v libx264 -t 3 -pix_fmt yuv420p "${videoPath}"`;
    
    execSync(ffmpegCommand, { stdio: 'pipe' });
    console.log('‚úÖ Sample video created');
    return videoPath;
    
  } catch (error) {
    console.log('‚ö†Ô∏è  ffmpeg not available, skipping video test');
    return null;
  }
}

async function simpleVideoTest() {
  console.log('üé• SIMPLE FACEBOOK VIDEO TEST');
  console.log('=============================\n');

  try {
    const env = ConfigLoader.loadEnvironment();
    console.log(`üìä Page: US Daily Tech Deals (${env.FB_PAGE_ID})`);

    const videoPath = await createSampleVideo();
    
    if (!videoPath) {
      console.log('‚ö†Ô∏è  Cannot test video without ffmpeg or existing MP4 file');
      return;
    }

    console.log(`üé• Video: ${videoPath}\n`);

    const facebookAPI = new FacebookAPI(env.FB_PAGE_ID, env.FB_PAGE_ACCESS_TOKEN);
    
    const description = `üé• Video Test from Node.js - ${new Date().toISOString()}\n\n‚úÖ Success! Facebook video posting is working correctly.\n\nüöÄ Posted via Graph API v19.0\n\nNote: Video processing may take a few minutes.`;

    console.log('üöÄ Uploading video...');
    const result = await facebookAPI.postVideo({ videoPath, description });

    if (result.success) {
      console.log('\n‚úÖ VIDEO UPLOAD SUCCESSFUL!');
      console.log(`üìù Video ID: ${result.videoId}`);
      
      const videoUrl = `https://www.facebook.com/${env.FB_PAGE_ID}/videos/${result.videoId}`;
      const pageUrl = `https://www.facebook.com/${env.FB_PAGE_ID}`;
      
      console.log(`üîó Video URL: ${videoUrl}`);
      console.log(`üè† Page: ${pageUrl}`);
      console.log('\n‚è≥ Video processing may take 1-5 minutes');
      console.log('üéâ Check your Facebook page to confirm!');
      
    } else {
      console.log('\n‚ùå FAILED TO UPLOAD VIDEO');
      console.log(`Error: ${result.message}`);
      if (result.error) {
        console.log('Details:', JSON.stringify(result.error, null, 2));
      }
    }

  } catch (error) {
    console.log(`‚ùå Error: ${error.message}`);
  }
}

simpleVideoTest().catch(console.error);